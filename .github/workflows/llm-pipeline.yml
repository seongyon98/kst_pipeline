name: Deploy LLM Code to EC2

on:
  push:

jobs:
  deploy:
    runs-on: ubuntu-latest  # 우분투 환경에서 실행

    steps: 
      # 1. 리포지토리 체크아웃
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. SSH key 설정 (GitHub Secrets에서 private key 로드)
      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_PUBLIC_IP }} >> ~/.ssh/known_hosts

      # 3. GitHub 인증 설정 (PAT을 사용하여 git 인증)
      - name: Set up Git authentication with PAT
        env:
            GH_TOKEN: ${{ secrets.GITACTION_TOKEN }}
        run: |
          git config --global url."https://x-access-token:${{ secrets.GITACTION_TOKEN }}@github.com".insteadOf "https://github.com"

      # 4. EC2에 코드 배포
      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_PUBLIC_IP }} << 'EOF'
            cd /labelling_pipeline/llm_api
            git pull origin main  # 최신 코드를 가져옵니다
            docker-compose down  # 기존 컨테이너 중지
            docker-compose up -d # 새 컨테이너 실행
          EOF
